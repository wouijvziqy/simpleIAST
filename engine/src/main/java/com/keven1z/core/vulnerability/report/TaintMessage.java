package com.keven1z.core.vulnerability.report;

import com.keven1z.core.model.graph.TaintData;
import com.keven1z.core.model.graph.TaintGraph;
import com.keven1z.core.model.graph.TaintNode;

import java.util.LinkedList;
import java.util.Map;

public class TaintMessage {
    private String agentId;
    private String url;
    private String method;
    private Map<String, String> requestHeaders;
    private Map<String, String> responseHeaders;

    /**
     * Http报文
     */
    private String requestBody;
    private String responseBody;

    private TaintGraph taintGraph;
    private TaintNode currentSinkNode;
    private LinkedList<TaintData> flowLinks;

    public TaintMessage(String agentId, String url, String method, TaintGraph taintGraph) {
        this.agentId = agentId;
        this.url = url;
        this.method = method;
        this.taintGraph = taintGraph;
    }

    public String getAgentId() {
        return agentId;
    }

    public void setAgentId(String agentId) {
        this.agentId = agentId;
    }

    public String getUrl() {
        return url;
    }

    public void setUrl(String url) {
        this.url = url;
    }

    public String getMethod() {
        return method;
    }

    public void setMethod(String method) {
        this.method = method;
    }

    public TaintGraph getTaintGraph() {
        return taintGraph;
    }

    public void setTaintGraph(TaintGraph taintGraph) {
        this.taintGraph = taintGraph;
    }

    public Map<String, String> getRequestHeaders() {
        return requestHeaders;
    }

    public void setRequestHeaders(Map<String, String> requestHeaders) {
        this.requestHeaders = requestHeaders;
    }

    public Map<String, String> getResponseHeaders() {
        return responseHeaders;
    }

    public void setResponseHeaders(Map<String, String> responseHeaders) {
        this.responseHeaders = responseHeaders;
    }

    public String getRequestBody() {
        return requestBody;
    }

    public void setRequestBody(String requestBody) {
        this.requestBody = requestBody;
    }

    public String getResponseBody() {
        return responseBody;
    }

    public void setResponseBody(String responseBody) {
        this.responseBody = responseBody;
    }

    public TaintNode getCurrentSinkNode() {
        return currentSinkNode;
    }
    public void fillMessage(TaintNode currentSinkNode){
        this.currentSinkNode = currentSinkNode;
        this.flowLinks  = null;
    }

    /**
     * 获取当前sink点的完整的链表
     */
    public LinkedList<TaintData> getFlowLinks() {
        if (this.flowLinks != null && !this.flowLinks.isEmpty()) {
            return this.flowLinks;
        }
        if (currentSinkNode == null) {
            return flowLinks;
        }
        this.flowLinks = taintGraph.bfs(currentSinkNode);
        return this.flowLinks;
    }

    /**
     * 清空TaintMessage
     */
    public void clear() {
        this.taintGraph.clear();
        if (requestHeaders != null) {
            this.requestHeaders.clear();
        }
        if (responseHeaders != null) {
            this.responseHeaders.clear();
        }
        if (currentSinkNode != null){
            currentSinkNode = null;
        }
        if (this.flowLinks != null){
            this.flowLinks.clear();
        }
    }
}
