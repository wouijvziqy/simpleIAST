package com.keven1z.core.vulnerability.detectors;

import com.keven1z.core.consts.VulnConst;
import com.keven1z.core.utils.FileUtils;
import com.keven1z.core.vulnerability.NormalDetector;
import java.io.IOException;
import java.util.HashSet;
import java.util.List;
import java.util.Properties;
import java.util.Set;

public class WeakPasswordInSqlDetector implements NormalDetector {
    private final Set<String> cache = new HashSet<>();
    private Object result;

    @Override
    public String getType() {
        return VulnConst.WEAK_PASSWORD_IN_SQL;
    }

    @Override
    public Object getReportDesc() {
        return result;
    }

    @Override
    public boolean detect(Object returnObject, Object thisObject, Object[] parameters) {
        if (parameters == null || parameters.length != 2) {
            return false;
        }
        if (!(parameters[0] instanceof String) || !(parameters[1] instanceof Properties)) {
            return false;
        }
        String url = (String) parameters[0];
        if (cache.contains(url)) {
            return false;
        } else {
            cache.add(url);
        }
        Properties properties = (Properties) parameters[1];
        String password = (String) properties.get("password");
        boolean isFound = false;
        try {
            List<String> weakPasswordList = FileUtils.loadWeakPassword(this.getClass().getClassLoader());
            if (weakPasswordList.contains(password)) {
                isFound = true;
            }
        } catch (IOException e) {
            return false;
        }
        if (isFound) {
            this.result = new WeakPasswordInSqlDesc(url, (String) properties.get("user"), password);
            return true;
        }
        return false;
    }

    private static class WeakPasswordInSqlDesc {
        private String url;
        private String user;
        private String password;

        public WeakPasswordInSqlDesc(String url, String user, String password) {
            this.url = url;
            this.user = user;
            this.password = password;
        }

        public String getUrl() {
            return url;
        }

        public void setUrl(String url) {
            this.url = url;
        }

        public String getUser() {
            return user;
        }

        public void setUser(String user) {
            this.user = user;
        }

        public String getPassword() {
            return password;
        }

        public void setPassword(String password) {
            this.password = password;
        }
    }
}
